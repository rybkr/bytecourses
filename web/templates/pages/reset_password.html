{{template "layout" .}}

{{define "title"}}Reset Your Password - ByteCourses{{end}}

{{define "content"}}
<div class="auth-container">
    <div class="auth-card">
        <h2>Reset Your Password</h2>
        <form id="resetPasswordForm" onsubmit="handleResetPassword(event)">
            <div class="form-group">
                <label for="password">New Password</label>
                <input type="password" id="password" name="password" required minlength="8">
            </div>
            <div class="form-group">
                <label for="confirmPassword">Confirm Password</label>
                <input type="password" id="confirmPassword" name="confirmPassword" required minlength="8">
            </div>
            <div id="error-message" class="error-message" style="display: none;"></div>
            <div id="success-message" class="success-message" style="display: none; padding: 1rem; border-radius: 0.375rem; margin-bottom: 1rem;"></div>
            <button type="submit" class="btn btn-primary btn-block">Reset Password</button>
        </form>
        <p class="auth-footer">
            Remember your password? <a href="/login">Login here</a>
        </p>
    </div>
</div>
{{end}}

{{define "scripts"}}
<script>
    function getTokenFromURL() {
        const params = new URLSearchParams(window.location.search);
        return params.get('token');
    }

    async function handleResetPassword(event) {
        event.preventDefault();
        const form = event.target;
        const password = form.password.value;
        const confirmPassword = form.confirmPassword.value;

        const errorDiv = document.getElementById('error-message');
        const successDiv = document.getElementById('success-message');
        errorDiv.style.display = 'none';
        successDiv.style.display = 'none';

        const token = getTokenFromURL();
        if (!token) {
            errorDiv.textContent = 'Invalid reset link. Please request a new password reset.';
            errorDiv.style.display = 'block';
            return;
        }

        if (password !== confirmPassword) {
            errorDiv.textContent = 'Passwords do not match.';
            errorDiv.style.display = 'block';
            return;
        }

        if (password.length < 8) {
            errorDiv.textContent = 'Password must be at least 8 characters long.';
            errorDiv.style.display = 'block';
            return;
        }

        try {
            const response = await fetch(`/api/password-reset/confirm?token=${encodeURIComponent(token)}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ password }),
            });

            if (response.status === 204) {
                form.style.display = 'none';
                successDiv.textContent = 'Password reset successfully! Redirecting to login...';
                successDiv.style.display = 'block';
                setTimeout(() => {
                    window.location.href = '/login';
                }, 2000);
            } else {
                const errorText = await response.text();
                errorDiv.textContent = errorText || 'Invalid or expired token. Please request a new password reset.';
                errorDiv.style.display = 'block';
            }
        } catch (error) {
            errorDiv.textContent = 'An error occurred. Please try again.';
            errorDiv.style.display = 'block';
        }
    }
</script>
{{end}}
